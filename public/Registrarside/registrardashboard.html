<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="registrardashboard.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- User Profile Section -->
            <div class="user-profile">
                <div class="avatar" id="avatarContainer">
                    <i class="fas fa-user-tie"></i>
                </div>
                <div class="user-info">
                    <h3 id="userName"></h3>
                    <div class="user-role">Registrar</div>
                </div>
            </div>
            
            <!-- Navigation Menu -->
            <div class="menu-label">Navigation</div>
            <ul class="nav-menu">
                <li class="nav-item active" data-section="dashboard">
                    <i class="fas fa-home"></i>
                    <span class="nav-text">Dashboard</span>
                </li>
                <li class="nav-item" data-section="enrollment">
                    <i class="fas fa-user-plus"></i>
                    <span class="nav-text">Enrollment</span>
                </li>
                <li class="nav-item" data-section="announcements">
                    <i class="fas fa-bullhorn"></i>
                    <span class="nav-text">Announcements</span>
                    
                </li>
                <li class="nav-item" data-section="students">
                    <i class="fas fa-user-graduate"></i>
                    <span class="nav-text">Students</span>
                </li>
                <li class="nav-item" data-section="grading">
                    <i class="fas fa-clipboard-list"></i>
                    <span class="nav-text">Grading</span>
                    
                </li>
                <li class="nav-item" data-section="messages">
                    <i class="fas fa-envelope"></i>
                    <span class="nav-text">Messages</span>
                    
                </li>
            </ul>
            
            <!-- Account Section -->
            <div class="menu-label">Account</div>
            <ul class="nav-menu">
                <li class="nav-item" data-section="profile">
                    <i class="fas fa-user"></i>
                    <span class="nav-text">Profile</span>
                </li>
                <li class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span class="nav-text">Settings</span>
                </li>
            </ul>
            
            <!-- Sidebar Footer -->
            <div class="sidebar-footer">
                <div class="mode-toggle">
                    <label for="darkModeToggle">Dark Mode</label>
                    <div class="switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="logout-text">Logout</span>
                </button>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header>
                <div class="welcome-message">Welcome, Dr. Joshua Almasco</div>
                <div class="header-actions">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" class="search-input" placeholder="Search...">
                    </div>
                    <div class="notification-icon" id="notificationIcon">
                        <i class="fas fa-bell"></i>
                        <span class="notification-count">3</span>
                    </div>
                </div>
            </header>
            
            <!-- Dashboard Content -->
            <div class="content-section active" id="dashboard">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <div class="card-icon">
                                    <i class="fas fa-chalkboard-teacher"></i>
                                </div>
                                Active Courses
                            </h3>
                            <div class="card-options">
                                <i class="fas fa-ellipsis-v"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <p>You are currently teaching 4 courses this semester. Manage your classes and track student progress.</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <div class="card-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                Pending Grades
                            </h3>
                            <div class="card-options">
                                <i class="fas fa-ellipsis-v"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <p>You have 12 assignments to grade. Review and submit grades before the deadline.</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <div class="card-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                Total Students
                            </h3>
                            <div class="card-options">
                                <i class="fas fa-ellipsis-v"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <p>You have 127 students enrolled across all your courses. Track attendance and performance.</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <div class="card-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                Upcoming Classes
                            </h3>
                            <div class="card-options">
                                <i class="fas fa-ellipsis-v"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <p>Check your schedule for upcoming classes, meetings, and important academic events.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enrollment Content Section -->
<div class="content-section" id="enrollment">
    <div class="enrollment-container">
        <div class="enrollment-header">
            <div class="header-left">
                <i class="fas fa-user-plus"></i>
                <div>
                    <h2>Enrollment Requests</h2>
                    <div class="enrollment-stats">
                        <div class="stat-item">
                            <i class="fas fa-clock"></i>
                            <span id="pending-count">0 Pending</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-check-circle"></i>
                            <span id="approved-count">0 Approved</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-times-circle"></i>
                            <span id="rejected-count">0 Rejected</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="export-btn">
                    <i class="fas fa-download"></i>
                    Export Data
                </button>
            </div>
        </div>

        <div class="enrollment-content">
            <div class="enrollment-filters">
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All Requests</button>
                    <button class="filter-btn" data-filter="pending">Pending</button>
                    <button class="filter-btn" data-filter="approved">Approved</button>
                    <button class="filter-btn" data-filter="rejected">Rejected</button>
                </div>
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" class="search-input" placeholder="Search student name..." id="enrollment-search">
                </div>
            </div>

            <div class="enrollment-list" id="enrollment-list">
                <!-- Enrollment cards will be populated by JavaScript -->
                <div class="no-enrollments" id="no-enrollments">
                    <i class="fas fa-user-graduate"></i>
                    <h3>No Enrollment Requests</h3>
                    <p>No enrollment requests found matching your criteria.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enrollment Details Modal -->
<div class="modal-overlay" id="enrollment-modal">
    <div class="modal">
        <div class="modal-header">
            <h3>Enrollment Details</h3>
            <button class="modal-close" onclick="closeEnrollmentModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="student-info-section">
                <h4>Student Information</h4>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Student ID:</label>
                        <span id="modal-student-id">-</span>
                    </div>
                    <div class="info-item">
                        <label>Full Name:</label>
                        <span id="modal-student-name">-</span>
                    </div>
                    <div class="info-item">
                        <label>Email:</label>
                        <span id="modal-student-email">-</span>
                    </div>
                    <div class="info-item">
                        <label>Contact Number:</label>
                        <span id="modal-student-contact">-</span>
                    </div>
                    <div class="info-item">
                        <label>Date of Birth:</label>
                        <span id="modal-student-dob">-</span>
                    </div>
                    <div class="info-item">
                        <label>Address:</label>
                        <span id="modal-student-address">-</span>
                    </div>
                </div>
            </div>

            <div class="enrollment-info-section">
                <h4>Enrollment Information</h4>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Program:</label>
                        <span id="modal-program">-</span>
                    </div>
                    <div class="info-item">
                        <label>Year Level:</label>
                        <span id="modal-year-level">-</span>
                    </div>
                    <div class="info-item">
                        <label>Academic Term:</label>
                        <span id="modal-academic-term">-</span>
                    </div>
                    <div class="info-item">
                        <label>Request Date:</label>
                        <span id="modal-request-date">-</span>
                    </div>
                    <div class="info-item">
                        <label>Status:</label>
                        <span id="modal-status" class="status-badge">-</span>
                    </div>
                </div>
            </div>

            <div class="documents-section">
                <h4>Submitted Documents</h4>
                <div class="documents-list" id="modal-documents">
                    <!-- Documents will be populated by JavaScript -->
                </div>
            </div>

            <div class="notes-section">
                <h4>Notes</h4>
                <div class="form-group">
                    <textarea class="form-input form-textarea" id="modal-notes" placeholder="Add notes about this enrollment request..."></textarea>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" onclick="updateEnrollmentStatus('rejected')">
                <i class="fas fa-times"></i>
                Reject
            </button>
            <button class="btn btn-secondary" onclick="closeEnrollmentModal()">
                Cancel
            </button>
            <button class="btn btn-primary" onclick="updateEnrollmentStatus('approved')">
                <i class="fas fa-check"></i>
                Approve
            </button>
        </div>
    </div>
</div>
            
            <!-- Announcements Content -->
            <div class="content-section" id="announcements">
                <div class="announcements-container">
        <!-- Header -->
        <div class="announcements-header">
            <div class="header-left">
                <i class="fas fa-bullhorn"></i>
                <div>
                    <h2>Announcements</h2>
                    <div class="announcement-stats">
                        <div class="stat-item">
                            <i class="fas fa-list"></i>
                            <span id="totalCount">0 Total</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-exclamation-circle"></i>
                            <span id="urgentCount">0 Urgent</span>
                        </div>
                    </div>
                </div>
            </div>
            <button class="add-announcement-btn" id="addAnnouncementBtn">
                <i class="fas fa-plus"></i>
                Add Announcement
            </button>
        </div>

        <!-- Content -->
        <div class="announcements-content">
            <!-- Filters -->
            <div class="announcements-filters">
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="urgent">Urgent</button>
                    <button class="filter-btn" data-filter="important">Important</button>
                    <button class="filter-btn" data-filter="general">General</button>
                </div>
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" class="search-input" placeholder="Search announcements..." id="searchInput">
                </div>
            </div>

            <!-- Announcements List -->
            <div class="announcements-list" id="announcementsList">
                <!-- No announcements message -->
                <div class="no-announcements" id="noAnnouncementsMessage">
                    <i class="fas fa-bullhorn"></i>
                    <h3>No Announcements Yet</h3>
                    <p>Click "Add Announcement" to create your first announcement.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Announcement Modal -->
    <div class="modal-overlay" id="announcementModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Announcement</h3>
                <button class="modal-close" id="modalCloseBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="announcementForm">
                    <div class="form-group">
                        <label class="form-label" for="announcementTitle">Title *</label>
                        <input type="text" class="form-input" id="announcementTitle" required placeholder="Enter announcement title">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="announcementContent">Content *</label>
                        <textarea class="form-input form-textarea" id="announcementContent" required placeholder="Enter announcement content..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="targetAudience">Target Audience</label>
                        <select class="form-input form-select" id="targetAudience">
                            <option value="All Students">All Students</option>
                            <option value="Freshman">Freshman</option>
                            <option value="Sophomore">Sophomore</option>
                            <option value="Junior">Junior</option>
                            <option value="Senior">Senior</option>
                            <option value="Graduate Students">Graduate Students</option>
                            <option value="Faculty">Faculty</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Priority Level *</label>
                        <div class="priority-options">
                            <div class="priority-option">
                                <input type="radio" class="priority-radio" id="priorityGeneral" name="priority" value="general" checked>
                                <label class="priority-label general" for="priorityGeneral">General</label>
                            </div>
                            <div class="priority-option">
                                <input type="radio" class="priority-radio" id="priorityImportant" name="priority" value="important">
                                <label class="priority-label important" for="priorityImportant">Important</label>
                            </div>
                            <div class="priority-option">
                                <input type="radio" class="priority-radio" id="priorityUrgent" name="priority" value="urgent">
                                <label class="priority-label urgent" for="priorityUrgent">Urgent</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelBtn">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary" id="saveBtn" form="announcementForm">
                    <i class="fas fa-save"></i>
                    Save Announcement
                </button>
            </div>
        </div>
    </div>
            </div>
            
            <!-- Students Content -->
            <div class="content-section" id="students">
                <h2>Students</h2>
                <p>View and manage student information, enrollment, and academic records.</p>
            </div>
            
            <!-- Grading Content -->
            <div class="content-section" id="grading">
                <h2>Grading</h2>
                <p>Grade assignments, exams, and manage student assessments.</p>
            </div>
            
            <!-- Messages Content -->
            <div class="content-section" id="messages">
                <div class="chat-container">
        <!-- Left Sidebar - Contacts -->
        <div class="contacts-panel">
            <div class="contacts-header">
                <h3>Messages</h3>
                <button class="new-chat-btn" onclick="openNewChatModal()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <div class="search-section">
                <div class="search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" class="search-input" placeholder="Search contacts..." oninput="filterContacts(this.value)">
                </div>
                <div class="role-filters">
                    <button class="role-tag active" onclick="filterByRole('all')">All</button>
                    <button class="role-tag" onclick="filterByRole('student')">Students</button>
                    <button class="role-tag" onclick="filterByRole('admin')">Admin</button>
                    <button class="role-tag" onclick="filterByRole('faculty')">Faculty</button>
                </div>
            </div>
            
            <div class="contacts-list" id="contactsList">
                <!-- Contacts will be populated here -->
            </div>
        </div>

        <!-- Right Panel - Chat -->
        <div class="chat-panel">
            <div class="empty-chat" id="emptyChat">
                <i class="fas fa-comments"></i>
                <h3>Welcome to Academic Chat</h3>
                <p>Select a contact from the left panel to start a conversation with faculty, administrators, or students.</p>
            </div>
            
            <div class="chat-header" id="chatHeader" style="display: none;">
                <button class="mobile-back-btn" onclick="closeMobileChat()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="chat-user-info">
                    <div class="chat-avatar" id="chatAvatar">
                        JD
                        <div class="online-indicator"></div>
                    </div>
                    <div class="chat-user-details">
                        <h4 id="chatUserName">John Doe</h4>
                        <p id="chatUserRole">Student • Computer Science</p>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn" onclick="toggleChatInfo()">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="chat-action-btn" onclick="archiveChat()">
                        <i class="fas fa-archive"></i>
                    </button>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages" style="display: none;">
                <!-- Messages will be populated here -->
            </div>
            
            <div class="chat-input-container" id="chatInputContainer" style="display: none;">
                <div class="chat-input-wrapper">
                    <textarea class="chat-input" id="messageInput" placeholder="Type a message..." rows="1" onkeypress="handleKeyPress(event)" oninput="autoResize(this)"></textarea>
                    <div class="input-actions">
                        <button class="input-action-btn" onclick="attachFile()">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="input-action-btn send-btn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div id="newChatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Start New Conversation</h3>
                <button class="close" onclick="closeNewChatModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" class="gmail-search" id="gmailSearch" placeholder="Search by Gmail address..." oninput="searchGmail(this.value)">
                <div class="search-results" id="searchResults">
                    <div class="no-results">Start typing to search for users...</div>
                </div>
            </div>
        </div>
    </div>
            </div>
            
            <!-- Profile Content -->
            <div class="content-section" id="profile">
                <h2>Profile</h2>
                <p>Manage your personal information and account settings.</p>
            </div>
            
            <!-- Settings Content -->
            <div class="content-section" id="settings">
                <h2>Settings</h2>
                <p>Configure your dashboard preferences and account settings.</p>
            </div>
        </main>
    </div>
    
    <script>
       document.addEventListener('DOMContentLoaded', function() {
    console.log("🎯 Registrar Dashboard loaded - checking authentication...");
    
    // ===== AUTHENTICATION FUNCTIONS =====
    
    // Check if user is authenticated (consistent with login.js)
    function checkAuthentication() {
        const isAuthenticated = sessionStorage.getItem('isAuthenticated') === 'true';
        const hasToken = sessionStorage.getItem('authToken') !== null;
        const hasUser = sessionStorage.getItem('userData') !== null;
        
        console.log("🔍 Auth status:", { isAuthenticated, hasToken, hasUser });
        
        if (!isAuthenticated || !hasToken || !hasUser) {
            console.log("❌ Not authenticated, redirecting to login...");
            // Fixed: Use relative path like in login.js
            window.location.href = '../login.html';
            return false;
        }
        
        // Check if user role is registrar
        const userRole = getUserRole();
        console.log("🎭 User role:", userRole);
        
        if (userRole !== 'registrar') {
            console.log("❌ Access denied - not a registrar role");
            alert('Access denied. This dashboard is for registrar accounts only.');
            window.location.href = '../login.html';
            return false;
        }
        
        return true;
    }
    
    // Get current user data (consistent with login.js)
    function getCurrentUser() {
        try {
            const userData = sessionStorage.getItem('userData');
            if (userData) {
                const user = JSON.parse(userData);
                console.log("👤 Current user retrieved:", user);
                return user;
            }
            console.log("❌ No user data found");
            return null;
        } catch (error) {
            console.error("❌ Error parsing user data:", error);
            return null;
        }
    }
    
    // Get user role (consistent with login.js)
    function getUserRole() {
        // Try stored role first
        const storedRole = sessionStorage.getItem('userRole');
        if (storedRole) {
            console.log("🎭 Role from storage:", storedRole);
            return storedRole;
        }
        
        // Try user data role
        const userData = sessionStorage.getItem('userData');
        if (userData) {
            try {
                const user = JSON.parse(userData);
                if (user.role) {
                    console.log("🎭 Role from user data:", user.role);
                    return user.role.toLowerCase();
                }
            } catch (error) {
                console.error("Error parsing user data for role:", error);
            }
        }
        
        console.log("🎭 Default role: student");
        return 'student';
    }
    
    // Enhanced server request with error handling
    async function makeServerRequest(url, options = {}) {
        const token = sessionStorage.getItem('authToken');
        
        // Add auth header if token exists
        const defaultHeaders = {
            'Content-Type': 'application/json',
            ...(token && { 'Authorization': `Bearer ${token}` })
        };
        
        const requestOptions = {
            ...options,
            headers: {
                ...defaultHeaders,
                ...options.headers
            }
        };
        
        try {
            const response = await fetch(url, requestOptions);
            
            // Handle authentication errors
            if (response.status === 401) {
                console.log("🔒 Authentication expired, redirecting to login...");
                sessionStorage.clear();
                window.location.href = '../login.html';
                return null;
            }
            
            return response;
        } catch (error) {
            console.error("🚨 Server request failed:", error);
            
            // Check if we just logged in - if so, don't show error
            const justLoggedIn = sessionStorage.getItem('justLoggedIn') === 'true';
            const skipServerCheck = sessionStorage.getItem('skipInitialServerCheck') === 'true';
            
            if (justLoggedIn || skipServerCheck) {
                console.log("⏭️ Skipping server error - just logged in");
                return null;
            }
            
            return null;
        }
    }
    
    // Load dashboard data with fallback
    async function loadDashboardData() {
        console.log("📊 Loading registrar dashboard data...");
        
        // Clear the login flags first
        sessionStorage.removeItem('justLoggedIn');
        sessionStorage.removeItem('skipInitialServerCheck');
        
        // Try to load announcements
        try {
            const response = await makeServerRequest('http://localhost:3006/api/announcements');
            if (response && response.ok) {
                const data = await response.json();
                console.log("📢 Announcements loaded:", data);
                // Update announcements UI here
            }
        } catch (error) {
            console.log("⚠️ Failed to load announcements, using offline mode");
        }
        
        console.log("📊 Registrar dashboard data loading complete");
    }
    
    // ===== DASHBOARD INITIALIZATION =====
    
    // Initialize dashboard with offline support
    function initializeDashboard() {
        console.log("🏁 Initializing registrar dashboard...");
        
        if (!checkAuthentication()) {
            return;
        }
        
        const user = getCurrentUser();
        if (!user) {
            console.log("❌ No user data found, redirecting to login...");
            window.location.href = '../login.html';
            return;
        }
        
        console.log("👤 Dashboard user:", user);
        
        // Get user info for display
        const userName = user.username || user.name || user.first_name || 'Registrar';
        const userEmail = user.email || '';
        const userRole = user.role || 'registrar';
        
        console.log("🎭 Display info:", { userName, userEmail, userRole });
        
        // Update UI with user info
        const userNameElements = document.querySelectorAll('[data-user-name]');
        userNameElements.forEach(el => {
            el.textContent = userName;
        });
        
        // Set user role
        const userRoleElements = document.querySelectorAll('[data-user-role]');
        userRoleElements.forEach(el => {
            el.textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
        });
        
        // Update specific elements if they exist
        const userNameDisplay = document.getElementById('userNameDisplay');
        const userRoleDisplay = document.getElementById('userRoleDisplay');
        const userMenuName = document.getElementById('userMenuName');
        const userMenuEmail = document.getElementById('userMenuEmail');
        const welcomeMessage = document.getElementById('welcomeMessage');

        if (userNameDisplay) {
            userNameDisplay.textContent = userName;
            console.log("✅ Updated userNameDisplay");
        }
        if (userRoleDisplay) {
            userRoleDisplay.textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
            console.log("✅ Updated userRoleDisplay");
        }
        if (userMenuName) {
            userMenuName.textContent = userName;
            console.log("✅ Updated userMenuName");
        }
        if (userMenuEmail) {
            userMenuEmail.textContent = userEmail;
            console.log("✅ Updated userMenuEmail");
        }
        if (welcomeMessage) {
            const firstName = userName.split(' ')[0];
            welcomeMessage.textContent = `Welcome, ${firstName}!`;
            console.log("✅ Updated welcomeMessage");
        }
        
        // Load dashboard data with error handling
        setTimeout(() => {
            loadDashboardData();
        }, 500);
        
        console.log("✅ Registrar dashboard initialized successfully");
    }
    
    // ===== DARK MODE FUNCTIONALITY =====
    function initializeDarkMode() {
        const darkModeToggle = document.getElementById('darkModeToggle');
        const htmlElement = document.documentElement;
        
        if (!darkModeToggle) {
            console.log("⚠️ Dark mode toggle not found");
            return;
        }
        
        // Dark mode toggle event listener
        darkModeToggle.addEventListener('change', function() {
            if (this.checked) {
                htmlElement.setAttribute('data-theme', 'dark');
                console.log("🌙 Dark mode enabled");
            } else {
                htmlElement.removeAttribute('data-theme');
                console.log("☀️ Light mode enabled");
            }
        });
        
        console.log("✅ Dark mode initialized");
    }

    // ===== UI FUNCTIONALITY =====
    
    // Sidebar toggle functionality
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    if (sidebarToggle && sidebar) {
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
            console.log("📱 Sidebar toggled");
        });
        console.log("✅ Sidebar toggle initialized");
    }
    
    // Navigation handling
    const navItems = document.querySelectorAll('.nav-item');
    const contentSections = document.querySelectorAll('.content-section');
    
    if (navItems.length > 0) {
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                const sectionName = this.getAttribute('data-section');
                console.log("📍 Navigating to section:", sectionName);
                
                // Remove active class from all nav items
                navItems.forEach(nav => nav.classList.remove('active'));
                // Add active class to clicked item
                this.classList.add('active');
                
                // Hide all content sections
                contentSections.forEach(section => section.classList.remove('active'));
                // Show selected content section
                const targetSection = document.getElementById(sectionName);
                if (targetSection) {
                    targetSection.classList.add('active');
                    console.log("✅ Switched to section:", sectionName);
                } else {
                    console.log("⚠️ Target section not found:", sectionName);
                }
            });
        });
        console.log("✅ Navigation initialized");
    }
    
    // Logout functionality
    window.logout = function() {
        console.log("🚪 Logging out...");
        sessionStorage.clear();
        window.location.href = '../login.html';
    };

    // Multiple logout buttons functionality
    const logoutBtns = [
        document.getElementById('logoutBtn'),
        document.getElementById('userMenuLogout')
    ];
    
    logoutBtns.forEach((btn, index) => {
        if (btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('Are you sure you want to logout?')) {
                    console.log(`🚪 Logout triggered from button ${index + 1}`);
                    sessionStorage.clear();
                    window.location.href = '../login.html';
                }
            });
            console.log(`✅ Logout button ${index + 1} initialized`);
        }
    });
    
    // Notification icon
    const notificationIcon = document.getElementById('notificationIcon');
    if (notificationIcon) {
        notificationIcon.addEventListener('click', function() {
            console.log("🔔 Notification clicked");
            alert('Notifications feature coming soon!');
        });
        console.log("✅ Notification icon initialized");
    }

    // Search functionality
    const searchInput = document.querySelector('.search-input');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            console.log('🔍 Searching for:', searchTerm);
            // Add your search logic here
        });
        console.log("✅ Search functionality initialized");
    }
    
    
    
    // ===== INITIALIZE EVERYTHING =====
    
    try {
        console.log("🚀 Starting registrar dashboard initialization...");
        
        // Initialize dark mode
        initializeDarkMode();
        
        // Initialize the dashboard
        initializeDashboard();
        
        // Initialize announcements after dashboard is ready
        setTimeout(() => {
            initializeAnnouncements();
        }, 1000);
        
        // Add periodic auth check
        setInterval(() => {
            if (!checkAuthentication()) {
                console.log("🔒 Periodic auth check failed, redirecting...");
                return;
            }
        }, 60000); // Check every minute
        
        console.log("✅ Complete registrar dashboard handler loaded successfully");
        
    } catch (error) {
        console.error("🚨 Error during dashboard initialization:", error);
    }
});

document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("announcementModal");
    const addBtn = document.getElementById("addAnnouncementBtn");
    const closeBtn = document.getElementById("modalCloseBtn");
    const cancelBtn = document.getElementById("cancelBtn");

    // Open modal
    addBtn.addEventListener("click", () => {
      modal.classList.add("active");
      document.body.classList.add("modal-open"); // optional: prevent scroll
    });

    // Close modal
    [closeBtn, cancelBtn].forEach((btn) =>
      btn.addEventListener("click", () => {
        modal.classList.remove("active");
        document.body.classList.remove("modal-open"); // optional
      })
    );
  });
    </script>
    <script src="../authCheck.js" defer></script>
    <script src="../chat.js" defer></script>
    <script src="registrardashboard.js" defer></script>
    
</body>
</html>